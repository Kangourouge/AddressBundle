{% block google_search_widget %}
    {{ block('form_widget') }}

    <script type="text/javascript">
        (function(){
            var locationInput = document.getElementById('{{ form.location.vars.id }}');
            var placeInput = document.getElementById('{{ form.place.vars.id }}');

            locationInput.addEventListener('keyup', onReset);
            locationInput.addEventListener('reset', onReset);
            locationInput.addEventListener('keydown', onKeyDown);
            locationInput.addEventListener('place_changed', onPlaceChange);

            function onPlaceChange(event) {
                fillPlaceInput(event.target.googleAutocomplete.getPlace());
            }

            function onKeyDown(event) {
                if (event.keyCode == 13) {
                    event.preventDefault();
                    searchPlaces();
                }
            }

            function onReset(event) {
                if (event.keyCode != 13) {
                    event.preventDefault();
                    placeInput.value = '';
                }
            }

            function searchPlaces() {
                var results = document.getElementsByClassName('pac-item');
                if (results === 'undefined') {
                    return false;
                }
                var firstResult = document.getElementsByClassName('pac-item')[0].childNodes;
                var placeName = firstResult[1].textContent;
                var placeAddress = firstResult[2].textContent;
                var geocoder = new google.maps.Geocoder();

                geocoder.geocode({'address': placeName + ' ' + placeAddress}, function(results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        if (results[0]) {
                            fillPlaceInput(results[0]);
                            locationInput.value = results[0].formatted_address;
                        }
                    }
                });
            }

            function fillPlaceInput(data) {
                var place = {};

                place['address_components'] = data.address_components;
                place['formatted_address'] = data.formatted_address;
                place['coordinate'] = {};
                if (data.geometry) {
                    place['coordinate']['latitude'] = data.geometry.location.lat();
                    place['coordinate']['longitude'] = data.geometry.location.lng();
                }
                place['types'] = data.types;
                place['vicinity'] = data.vicinity;

                placeInput.value = JSON.stringify(place);
            }
        })();
    </script>

{% endblock %}
